{"cells":[{"source":"<a href=\"https://www.kaggle.com/code/letslive/alpha-thalassemia-classifier-1?scriptVersionId=94126359\" target=\"_blank\"><img align=\"left\" alt=\"Kaggle\" title=\"Open in Kaggle\" src=\"https://kaggle.com/static/images/open-in-kaggle.svg\"></a>","metadata":{},"cell_type":"markdown","outputs":[],"execution_count":0},{"cell_type":"code","execution_count":1,"id":"8dbdc44f","metadata":{"_cell_guid":"b1076dfc-b9ad-4769-8c92-a6c4dae69d19","_uuid":"8f2839f25d086af736a60e9eeb907d3b93b6e0e5","execution":{"iopub.execute_input":"2022-04-27T07:46:02.102136Z","iopub.status.busy":"2022-04-27T07:46:02.101725Z","iopub.status.idle":"2022-04-27T07:46:02.116252Z","shell.execute_reply":"2022-04-27T07:46:02.1153Z"},"papermill":{"duration":0.056965,"end_time":"2022-04-27T07:46:02.118364","exception":true,"start_time":"2022-04-27T07:46:02.061399","status":"failed"},"tags":[]},"outputs":[{"name":"stderr","output_type":"stream","text":["UsageError: Line magic function `%matplotilib` not found.\n"]}],"source":["# This Python 3 environment comes with many helpful analytics libraries installed\n","# It is defined by the kaggle/python Docker image: https://github.com/kaggle/docker-python\n","# For example, here's several helpful packages to load\n","\n","import numpy as np # linear algebra\n","import pandas as pd # data processing, CSV file I/O (e.g. pd.read_csv)\n","from matplotlib import pyplot\n","%matplotilib inline\n","\n","# Input data files are available in the read-only \"../input/\" directory\n","# For example, running this (by clicking run or pressing Shift+Enter) will list all files under the input directory\n","\n","import os\n","for dirname, _, filenames in os.walk('/kaggle/input'):\n","    for filename in filenames:\n","        print(os.path.join(dirname, filename))\n","\n","# You can write up to 20GB to the current directory (/kaggle/working/) that gets preserved as output when you create a version using \"Save & Run All\" \n","# You can also write temporary files to /kaggle/temp/, but they won't be saved outside of the current session"]},{"cell_type":"code","execution_count":null,"id":"ca784d2a","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:45.740025Z","iopub.status.busy":"2022-04-27T06:27:45.739685Z","iopub.status.idle":"2022-04-27T06:27:47.225254Z","shell.execute_reply":"2022-04-27T06:27:47.224545Z","shell.execute_reply.started":"2022-04-27T06:27:45.739954Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["import matplotlib.pyplot as plt\n","import pandas as pd\n","import numpy as np\n","%matplotlib inline\n","import seaborn as sns\n","from imblearn.over_sampling import SMOTE\n","from xgboost import XGBClassifier\n","from xgboost import cv\n","from sklearn.model_selection import StratifiedKFold"]},{"cell_type":"code","execution_count":null,"id":"74926853","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.227138Z","iopub.status.busy":"2022-04-27T06:27:47.226906Z","iopub.status.idle":"2022-04-27T06:27:47.23287Z","shell.execute_reply":"2022-04-27T06:27:47.231732Z","shell.execute_reply.started":"2022-04-27T06:27:47.227105Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["import xgboost"]},{"cell_type":"code","execution_count":null,"id":"49daa1d9","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.236249Z","iopub.status.busy":"2022-04-27T06:27:47.234788Z","iopub.status.idle":"2022-04-27T06:27:47.254018Z","shell.execute_reply":"2022-04-27T06:27:47.253406Z","shell.execute_reply.started":"2022-04-27T06:27:47.236215Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["alphanorm = pd.read_csv('../input/alpha-thalassemia-dataset/alphanorm.csv', index_col = False)"]},{"cell_type":"code","execution_count":null,"id":"ee17c2d8","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.257313Z","iopub.status.busy":"2022-04-27T06:27:47.257117Z","iopub.status.idle":"2022-04-27T06:27:47.273351Z","shell.execute_reply":"2022-04-27T06:27:47.272663Z","shell.execute_reply.started":"2022-04-27T06:27:47.257273Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["alphanorm['rbc'] = alphanorm['rbc'].fillna(alphanorm.groupby('phenotype')['rbc'].transform('mean'))\n","alphanorm['mch'] = alphanorm['mch'].fillna(alphanorm.groupby('phenotype')['mch'].transform('mean'))"]},{"cell_type":"code","execution_count":null,"id":"9aeee566","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.27626Z","iopub.status.busy":"2022-04-27T06:27:47.275784Z","iopub.status.idle":"2022-04-27T06:27:47.322867Z","shell.execute_reply":"2022-04-27T06:27:47.322252Z","shell.execute_reply.started":"2022-04-27T06:27:47.276226Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["for col in alphanorm.columns:\n","    if alphanorm[col].dtype != object:\n","        Q1 = alphanorm[col].quantile(0.25)\n","        Q3 = alphanorm[col].quantile(0.75)\n","        IQR = Q3 - Q1\n","        S = 1.5*IQR\n","        LB = Q1 - S\n","        UB = Q3 + S\n","        print(UB)\n","        alphanorm.loc[alphanorm[col] > UB,col] = UB\n","        alphanorm.loc[alphanorm[col] < LB,col] = LB"]},{"cell_type":"code","execution_count":null,"id":"c4647d29","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.324192Z","iopub.status.busy":"2022-04-27T06:27:47.323895Z","iopub.status.idle":"2022-04-27T06:27:47.333508Z","shell.execute_reply":"2022-04-27T06:27:47.332797Z","shell.execute_reply.started":"2022-04-27T06:27:47.324158Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["alphanorm = alphanorm.astype({'sex' : 'category', 'phenotype' : 'category'})"]},{"cell_type":"code","execution_count":null,"id":"9a44c449","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.335433Z","iopub.status.busy":"2022-04-27T06:27:47.334871Z","iopub.status.idle":"2022-04-27T06:27:47.342534Z","shell.execute_reply":"2022-04-27T06:27:47.341624Z","shell.execute_reply.started":"2022-04-27T06:27:47.335386Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["alphanorm['phenotype'] = alphanorm['phenotype'] == 'alpha carrier'\n","alphanorm['phenotype'] = alphanorm['phenotype'].replace({True:1, False:0})"]},{"cell_type":"code","execution_count":null,"id":"65649e30","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.344119Z","iopub.status.busy":"2022-04-27T06:27:47.343775Z","iopub.status.idle":"2022-04-27T06:27:47.353567Z","shell.execute_reply":"2022-04-27T06:27:47.352835Z","shell.execute_reply.started":"2022-04-27T06:27:47.344085Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["X = alphanorm.drop('phenotype', axis=1)\n","y = alphanorm['phenotype']"]},{"cell_type":"code","execution_count":null,"id":"98775e8d","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:27:47.355152Z","iopub.status.busy":"2022-04-27T06:27:47.354813Z","iopub.status.idle":"2022-04-27T06:27:47.391018Z","shell.execute_reply":"2022-04-27T06:27:47.39015Z","shell.execute_reply.started":"2022-04-27T06:27:47.355115Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["X"]},{"cell_type":"code","execution_count":null,"id":"2817b178","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:19.043323Z","iopub.status.busy":"2022-04-27T06:28:19.043048Z","iopub.status.idle":"2022-04-27T06:28:19.053223Z","shell.execute_reply":"2022-04-27T06:28:19.052492Z","shell.execute_reply.started":"2022-04-27T06:28:19.043274Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["categorical_vars = list((X.select_dtypes(include=['category'])).columns)\n","categorical_vars"]},{"cell_type":"code","execution_count":null,"id":"11cb117f","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:29:32.851892Z","iopub.status.busy":"2022-04-27T06:29:32.85156Z","iopub.status.idle":"2022-04-27T06:29:32.994075Z","shell.execute_reply":"2022-04-27T06:29:32.992869Z","shell.execute_reply.started":"2022-04-27T06:29:32.851858Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":[]},{"cell_type":"code","execution_count":null,"id":"2ac10f2c","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:19.375148Z","iopub.status.busy":"2022-04-27T06:28:19.374946Z","iopub.status.idle":"2022-04-27T06:28:19.383127Z","shell.execute_reply":"2022-04-27T06:28:19.382428Z","shell.execute_reply.started":"2022-04-27T06:28:19.375123Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["from sklearn.preprocessing import OneHotEncoder\n","from sklearn.compose import ColumnTransformer"]},{"cell_type":"code","execution_count":null,"id":"52a78458","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:19.789095Z","iopub.status.busy":"2022-04-27T06:28:19.78881Z","iopub.status.idle":"2022-04-27T06:28:19.798696Z","shell.execute_reply":"2022-04-27T06:28:19.797459Z","shell.execute_reply.started":"2022-04-27T06:28:19.789067Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["one_hot = OneHotEncoder()\n","transformer = ColumnTransformer([('one_hot', one_hot, categorical_vars)], \n","                                remainder= 'passthrough')\n","X = pd.DataFrame(transformer.fit_transform(X))"]},{"cell_type":"code","execution_count":null,"id":"9bab30b6","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:21.185823Z","iopub.status.busy":"2022-04-27T06:28:21.185135Z","iopub.status.idle":"2022-04-27T06:28:21.196363Z","shell.execute_reply":"2022-04-27T06:28:21.195546Z","shell.execute_reply.started":"2022-04-27T06:28:21.185786Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["from sklearn.model_selection import StratifiedShuffleSplit\n","split = StratifiedShuffleSplit(n_splits=1, test_size=0.20, random_state=42)\n","for train_index, test_index in split.split(alphanorm, alphanorm[\"phenotype\"]):\n","    strat_train = alphanorm.loc[train_index]\n","    strat_test = alphanorm.loc[test_index]"]},{"cell_type":"code","execution_count":null,"id":"c5ba89da","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:21.485955Z","iopub.status.busy":"2022-04-27T06:28:21.485339Z","iopub.status.idle":"2022-04-27T06:28:21.499887Z","shell.execute_reply":"2022-04-27T06:28:21.493927Z","shell.execute_reply.started":"2022-04-27T06:28:21.48591Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["train_X = strat_train.drop('phenotype', axis=1)\n","train_y = strat_train['phenotype']\n","test_x = strat_test.drop('phenotype', axis=1)\n","test_y = strat_test['phenotype']"]},{"cell_type":"code","execution_count":null,"id":"d6baddeb","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:21.759734Z","iopub.status.busy":"2022-04-27T06:28:21.759316Z","iopub.status.idle":"2022-04-27T06:28:21.771305Z","shell.execute_reply":"2022-04-27T06:28:21.770465Z","shell.execute_reply.started":"2022-04-27T06:28:21.7597Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["one_hot1 = OneHotEncoder()\n","transformer = ColumnTransformer([('one_hot', one_hot1, categorical_vars)], \n","                                remainder= 'passthrough')\n","train_X = transformer.fit_transform(train_X)\n","train_X = pd.DataFrame(train_X)"]},{"cell_type":"code","execution_count":null,"id":"de634ba6","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:23.911992Z","iopub.status.busy":"2022-04-27T06:28:23.911203Z","iopub.status.idle":"2022-04-27T06:28:23.919644Z","shell.execute_reply":"2022-04-27T06:28:23.918785Z","shell.execute_reply.started":"2022-04-27T06:28:23.911954Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["one_hot2 = OneHotEncoder()\n","transformer = ColumnTransformer([('one_hot', one_hot2, categorical_vars)], \n","                                remainder= 'passthrough')\n","test_x = transformer.fit_transform(test_x)\n","test_x = pd.DataFrame(test_x)"]},{"cell_type":"code","execution_count":null,"id":"582aeb12","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:24.337485Z","iopub.status.busy":"2022-04-27T06:28:24.33651Z","iopub.status.idle":"2022-04-27T06:28:24.383611Z","shell.execute_reply":"2022-04-27T06:28:24.382828Z","shell.execute_reply.started":"2022-04-27T06:28:24.337434Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["train_X"]},{"cell_type":"code","execution_count":null,"id":"c83a18b5","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:31:17.396877Z","iopub.status.busy":"2022-04-27T06:31:17.396125Z","iopub.status.idle":"2022-04-27T06:31:17.40624Z","shell.execute_reply":"2022-04-27T06:31:17.40537Z","shell.execute_reply.started":"2022-04-27T06:31:17.39684Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["from sklearn import preprocessing\n","train_X = preprocessing.normalize(train_X)\n","test_x = preprocessing.normalize(test_x)\n","\n"]},{"cell_type":"code","execution_count":null,"id":"0169f0cb","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:31:25.335269Z","iopub.status.busy":"2022-04-27T06:31:25.335Z","iopub.status.idle":"2022-04-27T06:31:25.342627Z","shell.execute_reply":"2022-04-27T06:31:25.341698Z","shell.execute_reply.started":"2022-04-27T06:31:25.33524Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["from imblearn.over_sampling import SMOTE\n","sm = SMOTE(random_state = 2)\n","train_X, train_y = sm.fit_resample(train_X, train_y)"]},{"cell_type":"code","execution_count":null,"id":"2f32b768","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:32:08.045876Z","iopub.status.busy":"2022-04-27T06:32:08.045125Z","iopub.status.idle":"2022-04-27T06:32:08.052714Z","shell.execute_reply":"2022-04-27T06:32:08.052043Z","shell.execute_reply.started":"2022-04-27T06:32:08.045817Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["train_y.value_counts()"]},{"cell_type":"code","execution_count":null,"id":"cee43f14","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:32:10.544724Z","iopub.status.busy":"2022-04-27T06:32:10.544179Z","iopub.status.idle":"2022-04-27T06:32:10.548744Z","shell.execute_reply":"2022-04-27T06:32:10.547723Z","shell.execute_reply.started":"2022-04-27T06:32:10.544687Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["from sklearn.metrics import roc_auc_score\n","import optuna\n","from xgboost import XGBClassifier"]},{"cell_type":"code","execution_count":null,"id":"5e36ea54","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:32:10.879743Z","iopub.status.busy":"2022-04-27T06:32:10.879008Z","iopub.status.idle":"2022-04-27T06:32:10.885552Z","shell.execute_reply":"2022-04-27T06:32:10.884827Z","shell.execute_reply.started":"2022-04-27T06:32:10.879698Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["import xgboost"]},{"cell_type":"code","execution_count":null,"id":"f24e28fc","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:28:31.469141Z","iopub.status.busy":"2022-04-27T06:28:31.468889Z","iopub.status.idle":"2022-04-27T06:28:31.474652Z","shell.execute_reply":"2022-04-27T06:28:31.473843Z","shell.execute_reply.started":"2022-04-27T06:28:31.469114Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["xgboost.__version__"]},{"cell_type":"code","execution_count":null,"id":"e87c9918","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:32:13.558508Z","iopub.status.busy":"2022-04-27T06:32:13.558094Z","iopub.status.idle":"2022-04-27T06:32:13.56734Z","shell.execute_reply":"2022-04-27T06:32:13.566312Z","shell.execute_reply.started":"2022-04-27T06:32:13.558474Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["import joblib\n","joblib.__version__"]},{"cell_type":"code","execution_count":null,"id":"d8c547d2","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:52:24.386941Z","iopub.status.busy":"2022-04-27T06:52:24.386335Z","iopub.status.idle":"2022-04-27T06:52:24.390967Z","shell.execute_reply":"2022-04-27T06:52:24.390256Z","shell.execute_reply.started":"2022-04-27T06:52:24.386896Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["from sklearn.metrics import f1_score"]},{"cell_type":"markdown","id":"c8dad413","metadata":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"source":["Hyperparameter tuning with Optuna - we are using Recall as the metric, because the most important function of the model is to identify alpha thalassemia carriers"]},{"cell_type":"code","execution_count":null,"id":"e7f0e625","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:42:58.301148Z","iopub.status.busy":"2022-04-27T06:42:58.300718Z","iopub.status.idle":"2022-04-27T06:42:58.31769Z","shell.execute_reply":"2022-04-27T06:42:58.316726Z","shell.execute_reply.started":"2022-04-27T06:42:58.301106Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["def run(trial):\n","    learning_rate = trial.suggest_float(\"learning_rate\", 1e-2, 0.3, log=True)\n","    reg_lambda = trial.suggest_loguniform(\"reg_lambda\", 1e-8, 100.0)\n","    reg_alpha = trial.suggest_loguniform(\"reg_alpha\", 1e-8, 100.0)\n","    subsample = trial.suggest_float(\"subsample\", 0.1, 1.0)\n","    colsample_bytree = trial.suggest_float(\"colsample_bytree\", 0.1, 1.0)\n","    max_depth = trial.suggest_int(\"max_depth\", 1, 7)\n","    #gamma = trial.suggest_int(\"gamma\", 0, 1, 10)\n","    \n","\n","    \n","\n","    model = XGBClassifier(\n","        random_state=42,\n","        tree_method=\"gpu_hist\",\n","        gpu_id=1,\n","        predictor=\"gpu_predictor\",\n","        n_estimators=7000,\n","        learning_rate=learning_rate,\n","        reg_lambda=reg_lambda,\n","        reg_alpha=reg_alpha,\n","        subsample=subsample,\n","        colsample_bytree=colsample_bytree,\n","        max_depth=max_depth,\n","        \n","    )\n","    model.fit(train_X, train_y, early_stopping_rounds=15, eval_set=[(test_x, test_y)], verbose=True)\n","    preds_valid = model.predict(test_x)\n","    f1 = f1_score(test_y, preds_valid)\n","    return f1"]},{"cell_type":"code","execution_count":null,"id":"a8d9319b","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:52:28.976397Z","iopub.status.busy":"2022-04-27T06:52:28.975703Z","iopub.status.idle":"2022-04-27T06:52:30.2998Z","shell.execute_reply":"2022-04-27T06:52:30.299252Z","shell.execute_reply.started":"2022-04-27T06:52:28.976362Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["study = optuna.create_study(direction=\"maximize\")\n","study.optimize(run, n_trials=10)"]},{"cell_type":"code","execution_count":null,"id":"1812dc11","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:52:49.492184Z","iopub.status.busy":"2022-04-27T06:52:49.491919Z","iopub.status.idle":"2022-04-27T06:52:49.496284Z","shell.execute_reply":"2022-04-27T06:52:49.495571Z","shell.execute_reply.started":"2022-04-27T06:52:49.492152Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["#recall .8666\n","params = study.best_params\n"]},{"cell_type":"code","execution_count":null,"id":"6fda4da5","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:52:50.206351Z","iopub.status.busy":"2022-04-27T06:52:50.205965Z","iopub.status.idle":"2022-04-27T06:52:50.213983Z","shell.execute_reply":"2022-04-27T06:52:50.213106Z","shell.execute_reply.started":"2022-04-27T06:52:50.206321Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["params"]},{"cell_type":"code","execution_count":null,"id":"a3e1ea09","metadata":{"execution":{"iopub.execute_input":"2022-04-27T06:56:38.871333Z","iopub.status.busy":"2022-04-27T06:56:38.871055Z","iopub.status.idle":"2022-04-27T06:56:38.874858Z","shell.execute_reply":"2022-04-27T06:56:38.874189Z","shell.execute_reply.started":"2022-04-27T06:56:38.871283Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["params['max_depth'] = 3"]},{"cell_type":"code","execution_count":null,"id":"78b98b13","metadata":{"execution":{"iopub.execute_input":"2022-04-27T07:25:31.191614Z","iopub.status.busy":"2022-04-27T07:25:31.190968Z","iopub.status.idle":"2022-04-27T07:25:31.195458Z","shell.execute_reply":"2022-04-27T07:25:31.194691Z","shell.execute_reply.started":"2022-04-27T07:25:31.191573Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["params['learning_rate'] = 0.12"]},{"cell_type":"code","execution_count":null,"id":"46156603","metadata":{"execution":{"iopub.execute_input":"2022-04-27T07:25:32.12531Z","iopub.status.busy":"2022-04-27T07:25:32.124665Z","iopub.status.idle":"2022-04-27T07:25:32.357687Z","shell.execute_reply":"2022-04-27T07:25:32.357185Z","shell.execute_reply.started":"2022-04-27T07:25:32.125248Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["xgbmodel = XGBClassifier(random_state=42, min_child_weight=4, gamma=9.3,scale_pos_weight=.9, **params)\n","xgbmodel.fit(train_X, train_y, early_stopping_rounds=700, eval_metric=[\"error\",\"logloss\"],eval_set=[(train_X, train_y),(test_x, test_y)], verbose=True)"]},{"cell_type":"code","execution_count":null,"id":"457db5b3","metadata":{"execution":{"iopub.execute_input":"2022-04-27T07:26:16.77832Z","iopub.status.busy":"2022-04-27T07:26:16.778036Z","iopub.status.idle":"2022-04-27T07:26:16.794728Z","shell.execute_reply":"2022-04-27T07:26:16.793945Z","shell.execute_reply.started":"2022-04-27T07:26:16.77827Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["import joblib\n"," # Save the model as a pickle in a file\n","joblib.dump(xgbmodel, 'XGB.pkl')"]},{"cell_type":"code","execution_count":null,"id":"eabf2e66","metadata":{"execution":{"iopub.execute_input":"2022-04-27T07:26:29.274414Z","iopub.status.busy":"2022-04-27T07:26:29.27414Z","iopub.status.idle":"2022-04-27T07:26:29.28918Z","shell.execute_reply":"2022-04-27T07:26:29.288593Z","shell.execute_reply.started":"2022-04-27T07:26:29.274384Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["#predicting on validation set and evaluating\n","from sklearn.metrics import classification_report\n","y_preds = xgbmodel.predict(test_x)\n","print(classification_report(y_preds, test_y))\n"]},{"cell_type":"code","execution_count":null,"id":"7f9603bd","metadata":{"execution":{"iopub.execute_input":"2022-04-27T07:26:32.612644Z","iopub.status.busy":"2022-04-27T07:26:32.61239Z","iopub.status.idle":"2022-04-27T07:26:32.627648Z","shell.execute_reply":"2022-04-27T07:26:32.627129Z","shell.execute_reply.started":"2022-04-27T07:26:32.612618Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["#comparing with training set metrics\n","train_preds = xgbmodel.predict(train_X)\n","print(classification_report(train_preds, train_y))"]},{"cell_type":"code","execution_count":null,"id":"8b29f79d","metadata":{"_kg_hide-output":false,"execution":{"iopub.execute_input":"2022-04-27T07:26:41.673879Z","iopub.status.busy":"2022-04-27T07:26:41.673154Z","iopub.status.idle":"2022-04-27T07:26:42.039186Z","shell.execute_reply":"2022-04-27T07:26:42.038478Z","shell.execute_reply.started":"2022-04-27T07:26:41.673829Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["#plotting train error rate and test error rate to assess overfitting\n","\n","\n","# load data\n","\n","# retrieve performance metrics\n","results = xgbmodel.evals_result()\n","epochs = len(results['validation_0']['error'])\n","x_axis = range(0, epochs)\n","# plot log loss\n","fig, ax = pyplot.subplots()\n","ax.plot(x_axis, results['validation_0']['logloss'], label='Train')\n","ax.plot(x_axis, results['validation_1']['logloss'], label='Test')\n","ax.legend()\n","pyplot.ylabel('Log Loss')\n","pyplot.title('XGBoost Log Loss')\n","pyplot.show()\n","# plot classification error\n","fig, ax = pyplot.subplots()\n","ax.plot(x_axis, results['validation_0']['error'], label='Train')\n","ax.plot(x_axis, results['validation_1']['error'], label='Test')\n","ax.legend()\n","pyplot.ylabel('Classification Error')\n","pyplot.title('XGBoost Classification Error')\n","pyplot.show()"]},{"cell_type":"code","execution_count":null,"id":"de339757","metadata":{"execution":{"iopub.execute_input":"2022-04-27T07:26:47.77838Z","iopub.status.busy":"2022-04-27T07:26:47.777667Z","iopub.status.idle":"2022-04-27T07:26:48.011778Z","shell.execute_reply":"2022-04-27T07:26:48.011139Z","shell.execute_reply.started":"2022-04-27T07:26:47.778338Z"},"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["#final evaluation via Confusion matrix\n","from sklearn.metrics import confusion_matrix\n","from sklearn.metrics import plot_confusion_matrix\n","fig, ax =plt.subplots(figsize=(10, 10))\n","plot_confusion_matrix (xgbmodel, test_x, test_y, cmap=plt.cm.Blues, display_labels=['normals', 'alpha carriers'], ax=ax)"]},{"cell_type":"markdown","id":"9713922d","metadata":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"source":["****87% sensitivity in identifying alpha carriers! Also only 3 out of 11 normals in test set are wrongly classified :)**"]},{"cell_type":"code","execution_count":null,"id":"2e7ce31a","metadata":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":["#code snippet for deploying flask app -- see readme in github\n","from xgboost import XGBClassifier\n","import joblib\n","\n","def predictions(input) :\n","    input = np.array(input)\n","    input = np.reshape(input,(1, input.size))\n","    xgb = joblib.load('XGB2.pkl')\n","    prediction = xgb.predict(input)\n","    return prediction\n","\n","if pred == 0 :\n","    print('Likely to be a normal individual')\n","    print('Please note that this is model is at experimental stage and needs to be validated using prospective data, treat results with caution')\n","if pred == 1 :\n","    print('Likely to be an alpha thalassemia carrier')\n","    print('\\n')\n","    print('Please note that this is model is at experimental stage and needs to be validated using prospective data, treat results with caution')\n","    \n","    \n","    "]},{"cell_type":"code","execution_count":null,"id":"356d9417","metadata":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":[]},{"cell_type":"markdown","id":"bf6f94f8","metadata":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"source":["Thanks for reading! Feedback welcome :)"]},{"cell_type":"code","execution_count":null,"id":"7e39b7ea","metadata":{"papermill":{"duration":null,"end_time":null,"exception":null,"start_time":null,"status":"pending"},"tags":[]},"outputs":[],"source":[]}],"metadata":{"kernelspec":{"display_name":"Python 3","language":"python","name":"python3"},"language_info":{"codemirror_mode":{"name":"ipython","version":3},"file_extension":".py","mimetype":"text/x-python","name":"python","nbconvert_exporter":"python","pygments_lexer":"ipython3","version":"3.7.12"},"papermill":{"default_parameters":{},"duration":8.585877,"end_time":"2022-04-27T07:46:02.577588","environment_variables":{},"exception":true,"input_path":"__notebook__.ipynb","output_path":"__notebook__.ipynb","parameters":{},"start_time":"2022-04-27T07:45:53.991711","version":"2.3.4"}},"nbformat":4,"nbformat_minor":5}